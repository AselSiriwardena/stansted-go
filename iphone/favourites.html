<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Coupons</title>

    <!-- jQuery mobile files -->
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"/>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>


    <!-- Font awesome file -->
    <script src="https://kit.fontawesome.com/f083cf2118.js" crossorigin="anonymous"></script>

    <!-- Bootstrap CSS file -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Custom JS Files -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- Custom main CSS file -->
    <link rel="stylesheet" href="index.css">
    <script src="scripts/sendEmail.js"></script>
    <script src="https://smtpjs.com/v3/smtp.js"></script>

</head>

<body class="post-login">
<div data-role="page" class="coupons">
    <div data-role="header" id="header" class="px-4 pt-5 pb-4">
        <div class="ui-grid-a d-flex align-items-center header-title-back">
            <div class="ui-block-a d-flex align-items-center">
                <a href="home.html" class="ui-btn p-0 m-0 pathUrl" data-transition="slide" rel="external">
                    <img alt="back button" height="auto" src="assets/img/back.svg" width="30">
                </a>
                <h3 class="m-0 pl-3">Favourites</h3>
            </div>
            <div class="ui-block-b">
                <i class="fas fa-search" style="font-size: 19px;"></i>
            </div>
        </div>
    </div>
    <div data-role="main" class="px-4">
        <form>
            <fieldset data-role="controlgroup" data-iconpos="right" class="mt-0 mb-3">
                <div class="ui-grid-a" id="favList">
                </div>
            </fieldset>
        </form>
    </div>
    <div data-role="footer" class="page-footer" position="fixed" data-fullscreen="true">
        <div class="ui-grid-solo text-center sort-apply px-4">
            <div class="ui-block-a w100 mb-3">
                <a class="ui-btn btn primary-btn m-0" onclick="sendEmail()">SHARE VIA EMAIL</a>
            </div>
        </div>
        <div class="grid-container  border-rad-max">
            <div class="grid-item"><a href="home.html" data-transition="slide"><img src="assets/images/nav_home.svg"></a></a></div>
            <div class="grid-item"><a href="favourites.html" data-transition="slide"><img src="assets/images/nav_favourite_selected.svg"></a></a></div>
            <div class="grid-item"><a href="store.html" data-transition="slide"><img src="assets/images/nav_mini_logo.svg"></a></a></div>
            <div class="grid-item"><a href="trips.html" data-transition="slide"><img src="assets/images/nav_trips.svg"></a></a></div>
            <div class="grid-item"><a href="aboutUs.html" data-transition="slide"><img src="assets/images/nav_profile_selected.svg"></a></a></div>
        </div>
    </div>
</div>
<div class="overlay"></div>
<script>
    $(document).ready(function () {
        let favouriteList;
        changeValue = 'a';
        $.post("backend/userData.php", {
            action: 'view',
            currentUser: sessionStorage.getItem("loggedUser")
        }, function (data, status) {
            const json = JSON.parse(data);
            favouriteList = Object.values((json.favoriteList));
            $.post("backend/favourite.php", {
                action: 'getList',
                currentUser: sessionStorage.getItem("loggedUser"),
                favList: favouriteList
            }, function (data, status) {
                const jsonProducts = JSON.parse(data);
                jsonProducts.forEach(function (item) {
                    const jsonIterate = JSON.parse(item);
                    if (Object.keys(jsonProducts).length <= 1) {
                        $('#favCount').text(Object.keys(jsonProducts).length + " Item");
                    } else {
                        $('#favCount').text(Object.keys(jsonProducts).length + " Items");
                    }
                    //alert(JSON.stringify(jsonIterate));
                    jsonIterate.forEach(function (product) {

                        const ratings = product.rating;
                        const ratingInt = parseInt(ratings);
                        let ratingHtml = "";
                        for (let i = 0; i < 5; i++) {
                            if (ratingInt > i) {
                                ratingHtml = ratingHtml + `<i class="fas fa-star secondary-color-yellow-text"></i>`;
                            } else {
                                ratingHtml = ratingHtml + `<i class="far fa-star secondary-color-yellow-text"></i>`;
                            }
                        }
                        const favitem = `<div class ="ui-block-` + changeValue + ` w100 w-landscape-50"><div class="item">
                    <div class="ui-grid-solo">
                        <div class="ui-block-a w100 p-1">
                            <div class="card py-0 px-0 mx-0 mt-0">
                                <div class="top-card px-2 pb-2 pt-3">
                                    <div class = "ui-grid-a d-flex align-items-center">
                                        <div class="ui-block-a w40">
                                            <img alt="product Image" class="img-fluid" src="` + product.image + `" height="auto" width="100%">
                                        </div>
                                        <div class="ui-block-b w60">
                                            <div class = "prodContent">
                                                <div class="ui-grid-solo">
                                                    <div class="ui-block-a">
                                                        <h4 class="mt-0 truncate font-weight-bold m-0">` + product.name + `</h4>
                                                    </div>
                                                </div>
                                                <div class = "ui-grid-solo pt-1">
                                                    <div class="ui-block-a w100">
                                                        ` + ratingHtml + `
                                                    </div>
                                                </div>
                                            </div>
                                            <div class = "price mt-2">
                                                <div class="font-size-s text-muted font-weight-bold">
                                                    <del>20.99</del>
                                                </div>
                                                <div class="font-weight-heavy font-size-xl">
                                                    <div class="red">
                                                        <span class = "font-size-m font-weight-bold">USD</span> ` + product.price + `
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bottom-card ui-grid-a">
                                    <div class = "ui-grid-a d-flex align-items-center">
                                        <div class = "ui-block-a w10 text-left icon d-flex">
                                            <i class="fa fa-trash-o removeClick" accesskey="` + product.id + `"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div></div>`;
                        $("#favList").append(favitem);
                        $("#favList").trigger('change');
                        if (changeValue === 'a') {
                            changeValue = 'b';
                        } else if (changeValue === 'b') {
                            changeValue = 'a';
                        }
                    });
                });
            });
        });

        $(document).on("click", ".removeClick", function () {
            $.post("backend/favourite.php", {
                action: 'remove',
                currentUser: sessionStorage.getItem("loggedUser"),
                prodId: this.accessKey
            }, function (data, status) {
                location.reload(true);
            });
        });

    });
</script>
<script src="https://smtpjs.com/v3/smtp.js"></script>
<script>
    function sendEmail() {
        $.post("backend/userData.php", {
            action: 'view',
            currentUser: sessionStorage.getItem("loggedUser")
        }, function (data, status) {
            const json = JSON.parse(data);
            const favouriteList = Object.values((json.favoriteList));
            productItems(favouriteList);
            $("body").addClass("loading");
        });
    }

    function productItems(favouriteList) {
        let populatedList;
        $.post("backend/favourite.php", {
            action: 'getList',
            currentUser: sessionStorage.getItem("loggedUser"),
            favList: favouriteList
        }, function (data, status) {
            const jsonProducts = JSON.parse(data);
            let productItems = '';
            jsonProducts.forEach(function (item) {
                const jsonIterate = JSON.parse(item);
                jsonIterate.forEach(function (product) {

                    productItems = productItems + `<div class="item card" style="color:#313131;text-align:left;box-sizing: border-box;position: relative;display: flex;-webkit-box-orient: vertical;-webkit-box-direction: normal;-ms-flex-direction: column;flex-direction: column;min-width: 0;word-wrap: break-word;background-color: #FFFFFF;background-clip: border-box;border: none !important;border-radius: 10px;margin-bottom: 15px;padding: 20px 20px 10px;-webkit-box-shadow: 0 1px #FFFFFF inset, 0 1px 3px rgba(34, 25, 25, 0.4);-moz-box-shadow: 0 1px #FFFFFF inset, 0 1px 3px rgba(34, 25, 25, 0.4);box-shadow: 0 1px #FFFFFF inset, 0 1px 3px rgba(34, 25, 25, 0.4);max-width: 580px !important;">
                    <div class="ui-grid-a d-flex align-items-center" style="box-sizing: border-box;overflow: hidden;display: flex!important;-webkit-box-align: center!important;-ms-flex-align: center!important;align-items: center!important;">
                        <div class="ui-block-a w40" style="box-sizing: border-box;margin: 0;padding: 0;border: 0;float: left;min-height: 1px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;clear: left;width: 40% !important;">
                            <img alt="product Image" class="img-fluid" src="` + product.image + `" height="auto" width="100px" style="box-sizing: border-box;vertical-align: middle;border-style: none;page-break-inside: avoid;max-width: 100%;height: auto;">
                        </div>
                        <div class="ui-block-b w60" style="box-sizing: border-box;margin: 0;padding: 0;border: 0;float: left;min-height: 1px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;width: 60% !important;">
                            <div class="prodContent" style="box-sizing: border-box;">
                                <div class="ui-grid-solo" style="box-sizing: border-box;overflow: hidden;">
                                    <div class="ui-block-a" style="box-sizing: border-box;margin: 0;padding: 0;border: 0;float: none;min-height: 1px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;clear: left;width: 100%;">
                                        <h4 class="mt-0 truncate font-weight-bold m-0" style="box-sizing: border-box;margin-top: 0!important;margin-bottom: .5rem;font-family: inherit;font-weight: var(--font-weight-bold) !important;line-height: 1.2;color: inherit;font-size: 16px;margin: 0!important;">` + product.name + `</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="price mt-2" style="box-sizing: border-box;margin-top: .5rem!important;">
                                <div class="font-size-s text-muted font-weight-bold" style="box-sizing: border-box;font-weight: var(--font-weight-bold) !important;color: #6c757d!important;font-size: 12px !important;">
                                    <del style="box-sizing: border-box;">20.99</del>
                                </div>
                                <div class="font-weight-heavy font-size-xl" style="box-sizing: border-box;font-size: 22px;font-weight: var(--font-weight-heavy) !important;">
                                    <div class="primary-color-red-text" style="box-sizing: border-box;color: var(--primary-color-red) !important;">
                                        <span class="font-size-m font-weight-bold" style="box-sizing: border-box;font-weight: var(--font-weight-bold) !important;font-size: 14px !important;">USD</span> ` + product.price + `
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                });

                populatedList = productItems;
            });

            Email.send({
                Host: "smtp.gmail.com",
                Username: "stanstedgo@gmail.com",
                Password: "1234!acd",
                To: sessionStorage.getItem("loggedUser"),
                From: "stanstedgo@gmail.com",
                Subject: "Your Favourite Destinations",
                Body:
                    `<div style = " background: #4444C8;padding: 16px;">
    <div style="box-sizing: border-box;color:white;">
        <div style="box-sizing: border-box;overflow: hidden;margin-top: 1.5rem!important;margin-bottom: 1.5rem!important;text-align: center!important;">
            <img alt = "LOGO" src="assets/images/stanstedGoLogo.svg.svg" width="100px" style="box-sizing: border-box;vertical-align: middle;border-style: none;page-break-inside: avoid;max-width: 100%;height: auto;margin-bottom: 50px;">
            <h3 style="box-sizing: border-box;margin-top: 0;margin-bottom: .5rem;font-weight: 500;line-height: 1.2;font-size: 1.75rem;color: #FFFFFF;">Well hello there !</h3>
            "<h5 style="box-sizing: border-box;margin-top: 0;margin-bottom: 2.5rem;font-family: inherit;font-weight: 600 !important;line-height: 1.2;color: #FFFFFF !important;font-size: 1.25rem;"> Here are your favourite items </h5>
        </div>
        <div style="text-align: center">
            <div class = "items" style = 'display: inline-block'>
` + populatedList + `
            </div>
        </div>
        <div style='margin-top: 2.5rem;text-align: center'>
            <div style='display: inline-block'>
                <div style="box-sizing: border-box;padding-right: .5rem!important;font-size: 14px !important;"> Powered By</div>
                <img alt = 'footerLogo' src="assets/img/wooksMart-light.svg" width="100px" style="box-sizing: border-box;vertical-align: middle;border-style: none;page-break-inside: avoid;max-width: 100%;height: auto;">\\
            <div>
        </div>
    </div>
</div>`,
            }).then(
                setTimeout(function(){ $("body").removeClass("loading") }, 1700),
                message => alert("mail sent successfully"),
            );
        });
    }
</script>

<style>
    .overlay{
        display: none;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 999;
        background: rgba(255,255,255,0.8) url("assets/images/tenor.gif") center no-repeat;
    }
    body{
        text-align: center;
    }
    /* Turn off scrollbar when body element has the loading class */
    body.loading{
        overflow: hidden;
    }
    /* Make spinner image visible when body element has the loading class */
    body.loading .overlay{
        display: block;
    }
</style>

</body>

</html>
